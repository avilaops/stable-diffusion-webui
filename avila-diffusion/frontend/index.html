<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000">
    <title>Avila Diffusion - AI Image Generator</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --blue: #0d6efd;
            --blue-hover: #0b5ed7;
            --success: #198754;
            --spacing: 20px;
            --radius: 12px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --border-color: #30363d;
            --blue: #58a6ff;
            --blue-hover: #79c0ff;
            --success: #3fb950;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            transition: var(--transition);
        }

        /* Theme Toggle */
        .theme-toggle {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1000;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 8px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .theme-icon {
            font-size: 18px;
        }

        /* Hero Section */
        .hero {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px 40px;
            background: linear-gradient(180deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(13, 110, 253, 0.05) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .hero-content {
            max-width: 980px;
            width: 100%;
            text-align: center;
            z-index: 1;
        }

        h1 {
            font-size: clamp(48px, 8vw, 72px);
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 16px;
            color: var(--text-primary);
            animation: fadeInUp 0.8s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tagline {
            font-size: clamp(18px, 2.5vw, 24px);
            font-weight: 400;
            color: var(--text-secondary);
            margin-bottom: 48px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        /* Input Container */
        .input-container {
            width: 100%;
            max-width: 720px;
            margin: 0 auto 32px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .prompt-wrapper {
            position: relative;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .prompt-wrapper:focus-within {
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
            transform: translateY(-2px);
        }

        .prompt-input {
            width: 100%;
            padding: 24px 64px 24px 24px;
            font-size: 16px;
            font-weight: 400;
            border: none;
            border-radius: var(--radius);
            background: transparent;
            color: var(--text-primary);
            resize: none;
            outline: none;
            font-family: inherit;
            line-height: 1.6;
            min-height: 120px;
        }

        .prompt-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }        .generate-btn {
            position: absolute;
            right: 16px;
            bottom: 16px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--blue);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 4px 12px rgba(13, 110, 253, 0.4);
        }

        .generate-btn:hover:not(:disabled) {
            background: var(--blue-hover);
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(13, 110, 253, 0.5);
        }

        .generate-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .generate-btn svg {
            width: 24px;
            height: 24px;
            stroke: white;
            stroke-width: 2;
            fill: none;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            animation: fadeInUp 0.8s ease-out 0.6s both;
            margin-bottom: 48px;
        }

        .quick-btn {
            padding: 10px 20px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .quick-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        /* Canvas/Output */
        .canvas-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            animation: fadeInUp 0.8s ease-out 0.8s both;
        }

        .canvas {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            min-height: 600px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .canvas.generating {
            background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0),
                        linear-gradient(45deg, #f0f0f0 25%, transparent 25%, transparent 75%, #f0f0f0 75%, #f0f0f0);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            animation: slideBackground 1s linear infinite;
        }

        @keyframes slideBackground {
            from { background-position: 0 0, 10px 10px; }
            to { background-position: 20px 20px, 30px 30px; }
        }

        .canvas img {
            max-width: 100%;
            max-height: 600px;
            border-radius: 12px;
            object-fit: contain;
            opacity: 0;
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .placeholder {
            text-align: center;
            color: var(--gray);
            padding: 60px 40px;
        }

        .placeholder-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            opacity: 0.3;
        }

        .placeholder-icon svg {
            width: 100%;
            height: 100%;
            stroke: currentColor;
            fill: none;
            stroke-width: 1.5;
        }

        .placeholder h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark-gray);
        }

        .placeholder p {
            font-size: 17px;
            font-weight: 400;
        }

        /* Loading Spinner */
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--light-gray);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            background: var(--white);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .action-btn:hover:not(:disabled) {
            background: var(--light-gray);
            transform: translateY(-2px);
        }

        .action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .action-btn svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }

        /* Settings Panel */
        .settings-toggle {
            position: fixed;
            bottom: 32px;
            right: 32px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--dark-gray);
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .settings-toggle:hover {
            transform: scale(1.1) rotate(90deg);
            background: var(--black);
        }

        .settings-toggle svg {
            width: 24px;
            height: 24px;
            stroke: white;
            fill: none;
            stroke-width: 2;
        }

        .settings-panel {
            position: fixed;
            right: 0;
            top: 0;
            bottom: 0;
            width: 380px;
            background: var(--white);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.1);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 99;
            overflow-y: auto;
            padding: 32px;
        }

        .settings-panel.open {
            transform: translateX(0);
        }

        .settings-panel h2 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 32px;
        }

        .setting-group {
            margin-bottom: 32px;
        }

        .setting-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .size-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .size-option {
            padding: 16px;
            background: var(--light-gray);
            border: 2px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            font-size: 13px;
            font-weight: 600;
        }

        .size-option:hover {
            background: #e8e8ed;
        }

        .size-option.active {
            background: var(--blue);
            color: white;
            border-color: var(--blue);
        }

        .slider-container {
            margin-top: 12px;
        }

        .slider {
            width: 100%;
            height: 4px;
            background: var(--light-gray);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--blue);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-value {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 13px;
            color: var(--gray);
        }

        /* Gallery */
        .gallery-section {
            max-width: 1400px;
            margin: 80px auto;
            padding: 0 20px;
        }

        .section-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .section-header h2 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .section-header p {
            font-size: 21px;
            color: var(--gray);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .gallery-item {
            background: var(--white);
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .gallery-item:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .gallery-item img {
            width: 100%;
            height: 300px;
            object-fit: cover;
        }

        .gallery-svg {
            width: 100%;
            height: 300px;
            overflow: hidden;
        }

        .gallery-svg svg {
            width: 100%;
            height: 100%;
        }

        .gallery-item-info {
            padding: 16px;
        }

        .gallery-item-prompt {
            font-size: 14px;
            color: var(--dark-gray);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .gallery-item-meta {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 12px;
            color: var(--gray);
        }

        .gallery-empty {
            text-align: center;
            color: var(--gray);
            font-size: 16px;
            padding: 40px 0;
            grid-column: 1 / -1;
        }

        .history-actions {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .history-actions button {
            padding: 10px 18px;
            border: 1px solid var(--border-color);
            border-radius: 999px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-actions button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .history-clear-btn {
            border-color: #ff3b30;
            color: #ff3b30;
        }

        .history-clear-btn:hover {
            background: rgba(255, 59, 48, 0.08);
            box-shadow: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-panel {
                width: 100%;
            }

            .settings-toggle {
                bottom: 20px;
                right: 20px;
            }

            .gallery-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 48px;
            }

            .tagline {
                font-size: 21px;
            }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 32px;
            right: 32px;
            background: var(--white);
            padding: 20px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            transform: translateX(400px);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            max-width: 320px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #34c759;
        }

        .notification.error {
            border-left: 4px solid #ff3b30;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 14px;
            color: var(--gray);
        }
    </style>
</head>
<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle theme" aria-label="Toggle theme">
        <span class="theme-icon" id="themeIcon">üåô</span>
        <span id="themeText">Dark</span>
    </button>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1>Create. Imagine. Inspire.</h1>
            <p class="tagline">Transform your words into stunning visuals with AI</p>

            <div class="input-container">
                <div class="prompt-wrapper">
                    <label for="prompt" class="sr-only">Image prompt</label>
                    <textarea
                        class="prompt-input"
                        id="prompt"
                        placeholder="Describe your vision..."
                        rows="3"
                        aria-label="Enter image generation prompt"
                    ></textarea>
                    <button class="generate-btn" id="generateBtn" onclick="generate()" title="Generate image" aria-label="Generate image from prompt">
                        <svg viewBox="0 0 24 24">
                            <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linejoin="round" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="quick-actions">
                <button class="quick-btn" onclick="loadPreset('portrait')" aria-label="Load portrait preset">
                    üë§ Portrait
                </button>
                <button class="quick-btn" onclick="loadPreset('landscape')" aria-label="Load landscape preset">
                    üé≠Ô∏è Landscape
                </button>
                <button class="quick-btn" onclick="loadPreset('abstract')" aria-label="Load abstract preset">
                    üé® Abstract
                </button>
                <button class="quick-btn" onclick="loadPreset('cinematic')" aria-label="Load cinematic preset">
                    üé¨ Cinematic
                </button>
            </div>

            <div class="canvas-container">
                <div class="canvas" id="canvas">
                    <div class="placeholder">
                        <div class="placeholder-icon">
                            <svg viewBox="0 0 24 24">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                        <h3>Your masterpiece awaits</h3>
                        <p>Describe what you want to create above</p>
                    </div>
                </div>

                <div class="action-bar">
                    <button class="action-btn" id="downloadBtn" onclick="download()" disabled title="Download image" aria-label="Download generated image">
                        <svg viewBox="0 0 24 24">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="7 10 12 15 17 10"/>
                            <line x1="12" y1="15" x2="12" y2="3"/>
                        </svg>
                        Download
                    </button>
                    <button class="action-btn" id="shareBtn" onclick="share()" disabled title="Share image" aria-label="Share generated image">
                        <svg viewBox="0 0 24 24">
                            <circle cx="18" cy="5" r="3"/>
                            <circle cx="6" cy="12" r="3"/>
                            <circle cx="18" cy="19" r="3"/>
                            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                        </svg>
                        Share
                    </button>
                    <button class="action-btn" onclick="showHistory()" title="View history" aria-label="View generation history">
                        <svg viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12 6 12 12 16 14"/>
                        </svg>
                        History
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Gallery Section -->
    <section class="gallery-section" id="gallerySection" style="display: none;">
        <div class="section-header">
            <h2>Your Creations</h2>
            <p>Recent masterpieces generated by you</p>
            <div class="history-actions">
                <button type="button" onclick="refreshHistory()" aria-label="Refresh history gallery">Refresh</button>
                <button type="button" class="history-clear-btn" onclick="clearHistory()" aria-label="Clear generation history">Clear history</button>
            </div>
        </div>
        <div class="gallery-grid" id="galleryGrid"></div>
    </section>

    <!-- Settings Panel -->
    <button class="settings-toggle" onclick="toggleSettings()" title="Settings" aria-label="Open settings panel">
        <svg viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3"/>
            <path d="M12 1v6m0 6v6m8.66-14.66l-4.24 4.24m-4.24 4.24l-4.24 4.24M23 12h-6m-6 0H1m20.66 8.66l-4.24-4.24m-4.24-4.24l-4.24-4.24"/>
        </svg>
    </button>

    <div class="settings-panel" id="settingsPanel">
        <h2>Settings</h2>

        <div class="setting-group">
            <label>Image Size</label>
            <div class="size-grid">
                <div class="size-option" data-size="256" onclick="setSize(256, 256)">256√ó256</div>
                <div class="size-option active" data-size="512" onclick="setSize(512, 512)">512√ó512</div>
                <div class="size-option" data-size="768" onclick="setSize(768, 768)">768√ó768</div>
                <div class="size-option" data-size="1024" onclick="setSize(1024, 1024)">1024√ó1024</div>
                <div class="size-option" data-size="custom" onclick="setSize(1024, 768)">Portrait</div>
                <div class="size-option" data-size="custom2" onclick="setSize(768, 1024)">Landscape</div>
            </div>
        </div>

        <div class="setting-group">
            <label>Quality</label>
            <div class="slider-container">
                <input type="range" class="slider" id="stepsSlider" min="10" max="100" value="25">
                <div class="slider-value">
                    <span>Fast</span>
                    <span id="stepsValue">25 steps</span>
                    <span>Best</span>
                </div>
            </div>
        </div>

        <div class="setting-group">
            <label>Variations</label>
            <div class="slider-container">
                <input type="range" class="slider" id="batchSlider" min="1" max="4" value="1">
                <div class="slider-value">
                    <span>1 image</span>
                    <span id="batchValue">1 image</span>
                    <span>4 images</span>
                </div>
            </div>
        </div>

        <div class="setting-group">
            <label>Language</label>
            <div class="size-grid">
                <div class="size-option active" onclick="setLang('pt')">üáßüá∑ PT</div>
                <div class="size-option" onclick="setLang('fr')">üá´üá∑ FR</div>
                <div class="size-option" onclick="setLang('de')">üá©üá™ DE</div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-title" id="notificationTitle"></div>
        <div class="notification-message" id="notificationMessage"></div>
    </div>

    <script>
        let currentWidth = 512;
        let currentHeight = 512;
        let currentLang = 'pt';
        let generatedImageData = null;

        const HISTORY_STORAGE_KEY = 'avilaHistory';
        const MAX_HISTORY_ITEMS = 12;
        const MAX_HISTORY_BYTES = 4 * 1024 * 1024; // ~4MB budget to stay under browser quota

        function loadHistory() {
            try {
                const stored = localStorage.getItem(HISTORY_STORAGE_KEY);
                if (!stored) return [];
                const parsed = JSON.parse(stored);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.warn('Failed to read history from localStorage', error);
                return [];
            }
        }

        function persistHistory() {
            let trimmed = false;

            if (history.length > MAX_HISTORY_ITEMS) {
                history.splice(MAX_HISTORY_ITEMS);
                trimmed = true;
            }

            let serialized = JSON.stringify(history);
            while (serialized.length > MAX_HISTORY_BYTES && history.length > 0) {
                history.pop();
                serialized = JSON.stringify(history);
                trimmed = true;
            }

            try {
                localStorage.setItem(HISTORY_STORAGE_KEY, serialized);
            } catch (error) {
                console.warn('Failed to persist history, attempting to trim further', error);
                while (history.length > 0) {
                    history.pop();
                    serialized = JSON.stringify(history);
                    try {
                        localStorage.setItem(HISTORY_STORAGE_KEY, serialized);
                        trimmed = true;
                        break;
                    } catch (innerError) {
                        console.warn('Still over quota, removing another entry', innerError);
                    }
                }

                if (history.length === 0) {
                    try {
                        localStorage.removeItem(HISTORY_STORAGE_KEY);
                    } catch (removeError) {
                        console.warn('Failed to remove history key after trimming', removeError);
                    }
                }
            }

            return trimmed;
        }

        let history = loadHistory();
        history = history.map(entry => {
            const normalizedImage = normalizeImageData(entry.image);
            return {
                ...entry,
                image: normalizedImage,
                format: entry.format || detectImageFormat(normalizedImage),
                timestamp: entry.timestamp || normalizeTimestamp(entry.timestamp_ms || Date.now()),
            };
        });
        let isHistorySyncInProgress = false;

        const presets = {
            portrait: 'professional portrait, studio lighting, cinematic, sharp focus, 85mm lens, bokeh, high quality, 4k',
            landscape: 'epic landscape photography, golden hour, dramatic clouds, mountains, ultra wide angle, breathtaking, 4k',
            abstract: 'abstract art, vibrant colors, geometric shapes, modern, minimalist, high contrast, digital art',
            cinematic: 'cinematic scene, dramatic lighting, film grain, color grading, anamorphic, 2.35:1 aspect ratio'
        };

        // Generate image
        async function generate() {
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                notify('Empty Prompt', 'Please describe what you want to create', 'error');
                return;
            }

            const btn = document.getElementById('generateBtn');
            const canvas = document.getElementById('canvas');

            btn.disabled = true;
            canvas.className = 'canvas generating';
            canvas.innerHTML = '<div class="spinner"></div>';

            try {
                const steps = document.getElementById('stepsSlider').value;

                const response = await fetch('http://localhost:8080/txt2img', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        width: currentWidth,
                        height: currentHeight,
                        steps: parseInt(steps),
                        lang: currentLang
                    })
                });

                if (!response.ok) throw new Error('Generation failed');

                const data = await response.json();
                const imagePayload = Array.isArray(data.images) ? data.images[0] : null;
                generatedImageData = normalizeImageData(imagePayload);

                if (!generatedImageData) {
                    throw new Error('No image data returned');
                }

                canvas.className = 'canvas';

                const format = detectImageFormat(generatedImageData);
                if (format === 'svg') {
                    canvas.innerHTML = generatedImageData;
                } else {
                    const img = document.createElement('img');
                    img.src = format === 'data'
                        ? generatedImageData
                        : `data:image/png;base64,${generatedImageData}`;
                    canvas.innerHTML = '';
                    canvas.appendChild(img);
                }

                document.getElementById('downloadBtn').disabled = false;
                document.getElementById('shareBtn').disabled = false;

                const historyTrimmedLocal = saveToHistory(
                    prompt,
                    generatedImageData,
                    data.info || {},
                    data.history && data.history.id
                );
                updateGallery();
                await syncHistoryFromServer();

                const historyTrimmedServer = Boolean(data.history && data.history.trimmed);
                if (historyTrimmedLocal || historyTrimmedServer) {
                    notify('History trimmed', 'Oldest items were removed to free up space.', 'error');
                }

                notify('Success!', 'Your masterpiece is ready', 'success');

            } catch (error) {
                canvas.className = 'canvas';
                canvas.innerHTML = `
                    <div class="placeholder">
                        <h3>Generation failed</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                notify('Error', 'Failed to generate image', 'error');
            } finally {
                btn.disabled = false;
            }
        }

        // Load preset
        function loadPreset(type) {
            document.getElementById('prompt').value = presets[type];
            document.getElementById('prompt').focus();
        }

        // Set size
        function setSize(width, height) {
            currentWidth = width;
            currentHeight = height;
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Set language
        function setLang(lang) {
            currentLang = lang;
            document.querySelectorAll('[onclick^="setLang"]').forEach(el => el.classList.remove('active'));
            event.target.classList.add('active');
        }

        // Toggle settings
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('open');
        }

        // Download
        function download() {
            if (!generatedImageData) return;

            const format = detectImageFormat(generatedImageData);
            const link = document.createElement('a');

            if (format === 'svg') {
                const blob = new Blob([generatedImageData], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `avila-${Date.now()}.svg`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                return;
            }

            const href = format === 'data'
                ? generatedImageData
                : `data:image/png;base64,${generatedImageData}`;
            link.href = href;
            link.download = `avila-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function imageDataToBlob(data) {
            if (!data) return null;
            const format = detectImageFormat(data);
            if (format === 'svg') {
                return new Blob([data], { type: 'image/svg+xml' });
            }

            const href = format === 'data'
                ? data
                : `data:image/png;base64,${data}`;
            const response = await fetch(href);
            return await response.blob();
        }

        // Share
        async function share() {
            if (!generatedImageData) return;

            try {
                const blob = await imageDataToBlob(generatedImageData);
                if (!blob) {
                    notify('Share not supported', 'Could not prepare the image for sharing.', 'error');
                    return;
                }

                const extension = blob.type.includes('svg') ? 'svg' : 'png';
                const file = new File([blob], `avila.${extension}`, { type: blob.type || 'image/png' });

                if (navigator.share && (!navigator.canShare || navigator.canShare({ files: [file] }))) {
                    await navigator.share({
                        files: [file],
                        title: 'Avila Diffusion',
                        text: 'Check out my AI-generated masterpiece!'
                    });
                } else if (navigator.share) {
                    await navigator.share({
                        url: window.location.href,
                        title: 'Avila Diffusion',
                        text: 'Check out my AI-generated masterpiece!'
                    });
                } else {
                    notify('Share not supported', 'Download the image instead', 'error');
                }
            } catch (error) {
                console.log('Share cancelled', error);
            }
        }

        // History
        function normalizeImageData(imageData) {
            if (!imageData || typeof imageData !== 'string') return '';
            const trimmed = imageData.trim();
            if (trimmed.startsWith('<svg') || trimmed.startsWith('data:')) {
                return trimmed;
            }
            return `data:image/png;base64,${trimmed}`;
        }

        function detectImageFormat(imageData) {
            if (!imageData || typeof imageData !== 'string') return 'unknown';
            const trimmed = imageData.trim();
            if (trimmed.startsWith('<svg')) return 'svg';
            if (trimmed.startsWith('data:')) return 'data';
            return 'base64';
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function normalizeTimestamp(value) {
            if (typeof value === 'number' && Number.isFinite(value)) {
                return new Date(value).toISOString();
            }
            if (typeof value === 'string' && value) {
                const parsed = new Date(value);
                if (!Number.isNaN(parsed.valueOf())) {
                    return parsed.toISOString();
                }
            }
            return new Date().toISOString();
        }

        function renderHistoryImage(item) {
            const format = item.format || detectImageFormat(item.image);
            if (format === 'svg') {
                return `<div class="gallery-svg">${item.image}</div>`;
            }
            const src = format === 'data' ? item.image : `data:image/png;base64,${item.image ?? ''}`;
            return `<img src="${src}" alt="${escapeHtml(item.prompt)}">`;
        }

        function normalizeServerHistoryItem(item) {
            const image = normalizeImageData(item.image_data || item.image || '');
            return {
                id: item.id ?? Date.now(),
                prompt: item.prompt || '',
                image,
                format: detectImageFormat(image),
                width: item.width ?? 512,
                height: item.height ?? 512,
                time: typeof item.time_taken === 'number' ? item.time_taken : null,
                guidance: item.guidance,
                seed: item.seed ?? null,
                lang: item.lang || 'pt',
                mode: item.mode || 'light',
                timestamp: normalizeTimestamp(item.timestamp_ms ?? item.timestamp),
            };
        }

        function saveToHistory(prompt, image, info = {}, entryId) {
            const normalizedImage = normalizeImageData(image);
            const entry = {
                id: entryId ?? Date.now(),
                prompt,
                image: normalizedImage,
                format: detectImageFormat(normalizedImage),
                width: info.width ?? currentWidth,
                height: info.height ?? currentHeight,
                time: typeof info.time_taken === 'number' ? info.time_taken : null,
                guidance: info.guidance,
                seed: info.seed ?? null,
                mode: info.mode || 'light',
                lang: info.lang || currentLang,
                timestamp: normalizeTimestamp(info.timestamp_ms),
            };

            history.unshift(entry);
            const trimmed = persistHistory();
            return trimmed;
        }

        function updateGallery() {
            const grid = document.getElementById('galleryGrid');
            if (!grid) return;

            if (history.length === 0) {
                grid.innerHTML = '<div class="gallery-empty">No creations yet ‚Äî generate something amazing!</div>';
                return;
            }

            grid.innerHTML = history.map(item => {
                const metaPieces = [`${item.width}√ó${item.height}`];

                if (typeof item.time === 'number' && !Number.isNaN(item.time)) {
                    metaPieces.push(`${item.time.toFixed(1)}s`);
                }

                if (item.timestamp) {
                    const ts = new Date(item.timestamp);
                    if (!Number.isNaN(ts.valueOf())) {
                        metaPieces.push(ts.toLocaleString());
                    }
                }

                const metaHtml = metaPieces
                    .map(piece => `<span>${escapeHtml(piece)}</span>`)
                    .join('');

                return `
                    <div class="gallery-item" onclick="loadFromHistory(${item.id})">
                        ${renderHistoryImage(item)}
                        <div class="gallery-item-info">
                            <div class="gallery-item-prompt">${escapeHtml(item.prompt)}</div>
                            <div class="gallery-item-meta">${metaHtml}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function syncHistoryFromServer(showToast = false) {
            if (isHistorySyncInProgress) return false;
            isHistorySyncInProgress = true;

            try {
                const response = await fetch('/history');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const payload = await response.json();
                if (!payload || !Array.isArray(payload.items)) {
                    throw new Error('Invalid history payload');
                }

                history = payload.items.map(normalizeServerHistoryItem);
                persistHistory();
                updateGallery();

                if (showToast) {
                    notify('History updated', 'Latest generations loaded from the server.', 'success');
                }

                return true;
            } catch (error) {
                console.warn('Failed to sync history', error);
                if (showToast) {
                    notify('History sync failed', error.message || 'Unable to load history from the server.', 'error');
                }
                return false;
            } finally {
                isHistorySyncInProgress = false;
            }
        }

        async function refreshHistory() {
            await syncHistoryFromServer(true);
        }

        async function clearHistory() {
            if (isHistorySyncInProgress) return;

            try {
                const response = await fetch('/history', { method: 'DELETE' });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                history = [];
                persistHistory();
                updateGallery();
                notify('History cleared', 'All saved generations were removed.', 'success');
            } catch (error) {
                notify('Failed to clear history', error.message || 'Unable to clear history on the server.', 'error');
            }
        }

        async function showHistory() {
            const gallery = document.getElementById('gallerySection');
            const shouldShow = gallery.style.display === 'none';
            gallery.style.display = shouldShow ? 'block' : 'none';

            if (shouldShow) {
                await syncHistoryFromServer();
                updateGallery();
                gallery.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function loadFromHistory(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;

            document.getElementById('prompt').value = item.prompt || '';

            const canvas = document.getElementById('canvas');
            canvas.className = 'canvas';

            const format = item.format || detectImageFormat(item.image);
            if (format === 'svg') {
                canvas.innerHTML = item.image;
            } else if (item.image) {
                const img = document.createElement('img');
                img.src = format === 'data'
                    ? item.image
                    : `data:image/png;base64,${item.image}`;
                canvas.innerHTML = '';
                canvas.appendChild(img);
            }

            generatedImageData = format === 'svg'
                ? item.image
                : (format === 'data' ? item.image : `data:image/png;base64,${item.image}`);

            document.getElementById('downloadBtn').disabled = !generatedImageData;
            document.getElementById('shareBtn').disabled = !generatedImageData;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Notifications
        function notify(title, message, type = 'success') {
            const notification = document.getElementById('notification');
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        // Sliders
        document.getElementById('stepsSlider').addEventListener('input', (e) => {
            document.getElementById('stepsValue').textContent = `${e.target.value} steps`;
        });

        document.getElementById('batchSlider').addEventListener('input', (e) => {
            const value = e.target.value;
            document.getElementById('batchValue').textContent = `${value} image${value > 1 ? 's' : ''}`;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                generate();
            }
            if (e.key === 'Escape') {
                document.getElementById('settingsPanel').classList.remove('open');
            }
        });

        // Auto-focus prompt on load
        window.addEventListener('load', () => {
            document.getElementById('prompt').focus();
            loadTheme();
            updateGallery();
            syncHistoryFromServer();
        });

        // Theme Toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        }

        function updateThemeButton(theme) {
            const icon = document.getElementById('themeIcon');
            const text = document.getElementById('themeText');

            if (theme === 'dark') {
                icon.textContent = '‚òÄÔ∏è';
                text.textContent = 'Light';
            } else {
                icon.textContent = 'üåô';
                text.textContent = 'Dark';
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeButton(savedTheme);
        }
    </script>
</body>
</html>
